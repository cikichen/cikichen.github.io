<!DOCTYPE html>
<html lang="zh-CN">
    <head>
	<meta name="generator" content="Hugo 0.139.0">
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>编程心语</title><meta name="Description" content="This is my KeepIt site"><meta property="og:url" content="https://www.ithome.me/">
  <meta property="og:site_name" content="编程心语">
  <meta property="og:title" content="编程心语">
  <meta property="og:description" content="This is my KeepIt site">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="website">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="编程心语">
  <meta name="twitter:description" content="This is my KeepIt site">
      <meta name="twitter:site" content="@https://twitter.com/ChenCiki">
<meta name="application-name" content="My KeepIt site">
<meta name="apple-mobile-web-app-title" content="My KeepIt site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.ithome.me/" /><link rel="alternate" href="/index.xml" type="application/rss+xml" title="编程心语">
    <link rel="feed" href="/index.xml" type="application/rss+xml" title="编程心语"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "WebSite",
        "url": "https:\/\/www.ithome.me\/","inLanguage": "zh-CN","author": {
                "@type": "Person",
                "name": "SimonChen"
            },"description": "This is my KeepIt site","license": "©{year}, All Rights Reserved. Simon Chen","name": "编程心语"
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="编程心语">编程心语</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/about-me/"> 关于 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="编程心语">编程心语</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/about-me/" title="">关于</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="page home" data-home="posts"><div class="home-profile"><div class="home-avatar"><a href="/posts/" title="文章"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp"
        data-srcset="https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp, https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp 1.5x, https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp 2x"
        data-sizes="auto"
        alt="https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp"
        title="https://www.gravatar.com/avatar/7a0c24f697ea1587001c36d00039b60f?s=240&amp;d=mp" /></a></div><div class="home-subtitle"><div id="id-1" class="typeit"></div></div></div>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2016/01/23/linearlayout%E5%AE%9E%E7%8E%B0%E6%A8%AA%E5%90%91%E8%B7%91%E9%A9%AC%E7%81%AF%E6%95%88%E6%9E%9C/">LinearLayout实现横向跑马灯效果</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2016-01-23">2016-01-23</time></span></div><div class="content"><p>开发过程中，我们常常要实现各种各样的效果，跑马灯就是其中之一。android的<code>TextView</code>可以设置属性<code>android:ellipsize=&quot;marquee&quot;</code>来实现跑马灯效果，但是如果我们的是要实现图文并茂的复杂布局的跑马灯，<code>TextView</code>就有点捉襟见肘了。</p>
<p>先来看下效果图:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://7xq9ge.com1.z0.glb.clouddn.com/FqJaX95ZDTGut5sKeX97hmf2RUjS"
        data-srcset="http://7xq9ge.com1.z0.glb.clouddn.com/FqJaX95ZDTGut5sKeX97hmf2RUjS, http://7xq9ge.com1.z0.glb.clouddn.com/FqJaX95ZDTGut5sKeX97hmf2RUjS 1.5x, http://7xq9ge.com1.z0.glb.clouddn.com/FqJaX95ZDTGut5sKeX97hmf2RUjS 2x"
        data-sizes="auto"
        alt="http://7xq9ge.com1.z0.glb.clouddn.com/FqJaX95ZDTGut5sKeX97hmf2RUjS"
        title="hammerheadMMB29Ksimonchen01232016151025" /></p>
<p>既有图片，又有文字。我们看到这种效果，一般会想到通过自定义控件来实现，但是处理起来还是有点麻烦。那么我们可以怎样来实现呢？</p>
<h4 id="objectanimator">ObjectAnimator</h4>
<p>Android属性动画。跑马灯实际就是一个横向的位移效果。我们完全可以通过通过给<code>View</code>设置动画来实现，而且非常简单。</p>
<p><code>ObjectAnimator</code>是从API11，也就是android3.0开始引入的。网上有很多相关的文章了，这里就不详细介绍了。我们只关注我们需要实现动画的方法。</p>
<p><code>ofFloat(Object target, String propertyName, float... values) Constructs and returns an ObjectAnimator that animates between float values.</code></p>
<p>第一个参数: 需要执行动画的<code>View</code>
第二个参数: 动画类型，因为我们是需要执行横向移动效果，所以直接传入<code>&quot;translationX&quot;</code>
第三个参数: 这是一个可变的float参数。因为我们是需要从右到左的执行。按照坐标规律，数字是从大到小，因为跑马灯需要滚出视图区域，所以结束位置一定是一个负数。<code>float... values</code>可以只传入一个值，代表从当前位置往右边移动多少。可以自己设置不同的值来看效果。</p>
<p>那么如何实现我们图中的效果呢？控件默认位置是0，需要让它从最右边执行到最左边。</p></div><div class="post-footer">
        <a href="/post/2016/01/23/linearlayout%E5%AE%9E%E7%8E%B0%E6%A8%AA%E5%90%91%E8%B7%91%E9%A9%AC%E7%81%AF%E6%95%88%E6%9E%9C/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/android/">Android</a>,&nbsp;<a href="/tags/%E8%B7%91%E9%A9%AC%E7%81%AF/">跑马灯</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2016/01/21/react-native%E9%A6%96%E6%AC%A1%E8%BF%90%E8%A1%8C%E6%8F%90%E7%A4%BA-referenceerror-can-t-find-variable-fbbatchedbridge/">React Native首次运行提示&#39;ReferenceError: Can&#39;t find variable: _fbBatchedBridge&#39;</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2016-01-21">2016-01-21</time></span></div><div class="content"><p>React Native目前貌似要火的样子，作为移动开发人员，当然需要关注最新的开发技术，所以也就跟风试了试，但是发现运行的时候红屏报错，谷歌了一下，发现官网给出了解决方案，步骤如下:</p>
<ol>
<li>确保你的电脑和手机处于同一个wifi网络</li>
<li>从手机上启动你的React Native app。</li>
<li>你看见的是一个堆满error错误的红屏，请按照接下来的步骤修复它。</li>
<li>通过摇晃手机或者在命令行运行<code>adb shell input keyevent 82</code>打开开发者菜单，如下图所示
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://7xq9ge.com1.z0.glb.clouddn.com/Fo4vETWlkxRcIpmV-QSu59mO5jWP"
        data-srcset="http://7xq9ge.com1.z0.glb.clouddn.com/Fo4vETWlkxRcIpmV-QSu59mO5jWP, http://7xq9ge.com1.z0.glb.clouddn.com/Fo4vETWlkxRcIpmV-QSu59mO5jWP 1.5x, http://7xq9ge.com1.z0.glb.clouddn.com/Fo4vETWlkxRcIpmV-QSu59mO5jWP 2x"
        data-sizes="auto"
        alt="http://7xq9ge.com1.z0.glb.clouddn.com/Fo4vETWlkxRcIpmV-QSu59mO5jWP"
        title="device-2016-01-21-104301" /></li>
<li>进入<code>Dev Settings</code>.</li>
<li>点击<code>Debug server host for device</code></li>
<li>手动键入你电脑的IP地址和本地开发服务器的端口，默认端口是的8081(e.g. 10.0.1.1:8081)
查看电脑IP的方法:</li>
</ol>
<ul>
<li>Mac: 系统偏好设置-网络</li>
<li>Windows: 打开命令行，输入<code>ipconfig</code></li>
</ul>
<ol start="8">
<li>返回后重新选择<code>Reload JS</code>。</li>
</ol>
<p>如果一切正常，应该就能正常加载显示了。Gook luck!</p></div><div class="post-footer">
        <a href="/post/2016/01/21/react-native%E9%A6%96%E6%AC%A1%E8%BF%90%E8%A1%8C%E6%8F%90%E7%A4%BA-referenceerror-can-t-find-variable-fbbatchedbridge/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/reactnative/">ReactNative</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2016/01/19/android-gc-%E9%82%A3%E7%82%B9%E4%BA%8B/">Android GC 那点事</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2016-01-19">2016-01-19</time></span></div><div class="content"><p>想写一篇关于Android GC的想法来源于追查一个魅族手机图片滑动卡顿问题，由于不断的GC导致的丢帧卡顿的问题让我们想了很多方案去解决，所以就打算详细的看看内存分配和GC的原理，为什么会不断的GC, GC ALLOC和GC COCURRENT有什么区别，能不能想办法扩大堆内存减少GC的频次等等。</p>
<h3 id="1-jvm内存回收机制">1. JVM内存回收机制</h3>
<h4 id="11-回收算法">1.1. 回收算法</h4>
<h5 id="标记回收算法mark-and-sweep-gc">标记回收算法（Mark and Sweep GC）</h5>
<p>从&quot;GC Roots&quot;集合开始，将内存整个遍历一次，保留所有可以被GC Roots直接或间接引用到的对象，而剩下的对象都当作垃圾对待并回收，这个算法需要中断进程内其它组件的执行并且可能产生内存碎片。</p>
<h5 id="复制算法-copying">复制算法 (Copying）</h5>
<p>将现有的内存空间分为两快，每次只使用其中一块，在垃圾回收时将正在使用的内存中的存活对象复制到未被使用的内存块中，之后，清除正在使用的内存块中的所有对象，交换两个内存的角色，完成垃圾回收。</p>
<h5 id="标记-压缩算法-mark-compact">标记-压缩算法 (Mark-Compact)</h5>
<p>先需要从根节点开始对所有可达对象做一次标记，但之后，它并不简单地清理未标记的对象，而是将所有的存活对象压缩到内存的一端。之后，清理边界外所有的空间。这种方法既避免了碎片的产生，又不需要两块相同的内存空间，因此，其性价比比较高。</p>
<h5 id="分代">分代</h5>
<p>将所有的新建对象都放入称为年轻代的内存区域，年轻代的特点是对象会很快回收，因此，在年轻代就选择效率较高的复制算法。当一个对象经过几次回收后依然存活，对象就会被放入称为老生代的内存空间。对于新生代适用于复制算法，而对于老年代则采取标记-压缩算法。</p>
<h4 id="12-复制和标记-压缩算法的区别">1.2. 复制和标记-压缩算法的区别</h4>
<p>乍一看这两个算法似乎并没有多大的区别，都是标记了然后挪到另外的内存地址进行回收，那为什么不同的分代要使用不同的回收算法呢？
其实2者最大的区别在于前者是用空间换时间后者则是用时间换空间。
前者的在工作的时候是不没有独立的“Mark”与“Copy”阶段的，而是合在一起做一个动作，就叫Scavenge（或Evacuate，或者就叫Copy）。也就是说，每发现一个这次收集中尚未访问过的活对象就直接Copy到新地方，同时设置Forwarding Pointer，这样的工作方式就需要多一份空间。
后者在工作的时候则需要分别的Mark与Compact阶段，Mark阶段用来发现并标记所有活的对象，然后compact阶段才移动对象来达到Compact的目的。如果Compact方式是Sliding Compaction，则在Mark之后就可以按顺序一个个对象“滑动”到空间的某一侧。因为已经先遍历了整个空间里的对象图，知道所有的活对象了，所以移动的时候就可以在同一个空间内而不需要多一份空间。
所以新生代的回收会更快一点，老年代的回收则会需要更长时间，同时压缩阶段是会暂停应用的，所以给我们应该尽量避免对象出现在老年代。</p>
<!-- raw HTML omitted -->
<h3 id="2-dalvik虚拟机">2. Dalvik虚拟机</h3>
<h4 id="21-java堆">2.1. Java堆</h4>
<p>Java堆实际上是由一个Active堆和一个Zygote堆组成的，其中，Zygote堆用来管理Zygote进程在启动过程中预加载和创建的各种对象，而Active堆是在Zygote进程Fork第一个子进程之前创建的。以后启动的所有应用程序进程是被Zygote进程Fork出来的，并都持有一个自己的Dalvik虚拟机。在创建应用程序的过程中，Dalvik虚拟机采用Cow策略复制Zygote进程的地址空间。
<strong>Cow策略</strong>：一开始的时候（未复制Zygote进程的地址空间的时候），应用程序进程和Zygote进程共享了同一个用来分配对象的堆。当Zygote进程或者应用程序进程对该堆进行写操作时，内核就会执
行真正的拷贝操作，使得Zygote进程和应用程序进程分别拥有自己的一份拷贝，这就是所谓的Cow。因为Copy是十分耗时的，所以必须尽量避免Copy或者尽量少的Copy。
为了实现这个目的，当创建第一个应用程序进程时，会将已经使用了的那部分堆内存划分为一部分，还没有使用的堆内存划分为另外一部分。前者就称为Zygote堆，后者就称为Active堆。这样只需把zygote堆中的内容复制给应用程序进程就可以了。以后无论是Zygote进程，还是应用程序进程，当它们需要分配对象的时候，都在Active堆上进行。这样就可以使得Zygote堆尽可能少地被执行写操作，因而就可以减少执行写时拷贝的操作。在Zygote堆里面分配的对象其实主要就是Zygote进程在启动过程中预加载的类、资源和对象了。这意味着这些预加载的类、资源和对象可以在Zygote进程和应用程序进程中做到长期共享。这样既能减少拷贝操作，还能减少对内存的需求。</p>
<h4 id="22-和gc有关的一些指标">2.2. 和GC有关的一些指标</h4>
<p>记得我们之前在优化魅族某手机的gc卡顿问题时，发现他很容易触发GC_FOR_MALLOC，这个GC类别后续会说到，是分配对象内存不足时导致的。可是我们又设置了很大的堆Size为什么还会内存不够呢，这里需要了解以下几个概念：分别是Java堆的起始大小（Starting Size）、最大值（Maximum Size）和增长上限值（Growth Limit）。
在启动Dalvik虚拟机的时候，我们可以分别通过-Xms、-Xmx和-XX:HeapGrowthLimit三个选项来指定上述三个值，以上三个值分别表示表示：
<code>Starting Size</code>: Dalvik虚拟机启动的时候，会先分配一块初始的堆内存给虚拟机使用。
<code>Growth Limit</code>: 是系统给每一个程序的最大堆上限,超过这个上限，程序就会OOM。
<code>Maximum Size</code>: 不受控情况下的最大堆内存大小，起始就是我们在用largeheap属性的时候，可以从系统获取的最大堆大小。
同时除了上面的这个三个指标外，还有几个指标也是值得我们关注的，那就是堆最小空闲值（Min Free）、堆最大空闲值（Max Free）和堆目标利用率（Target Utilization）。假设在某一次GC之后，存活对象占用内存的大小为LiveSize，那么这时候堆的理想大小应该为(LiveSize / U)。但是(LiveSize / U)必须大于等于(LiveSize + MinFree)并且小于等于(LiveSize + MaxFree)，每次GC后垃圾回收器都会尽量让堆的利用率往目标利用率靠拢。所以当我们尝试手动去生成一些几百K的对象，试图去扩大可用堆大小的时候，反而会导致频繁的GC，因为这些对象的分配会导致GC，而GC后会让堆内存回到合适的比例，而我们使用的局部变量很快会被回收理论上存活对象还是那么多，我们的堆大小也会缩减回来无法达到扩充的目的。 与此同时这也是产生CONCURRENT GC的一个因素，后文我们会详细讲到。</p></div><div class="post-footer">
        <a href="/post/2016/01/19/android-gc-%E9%82%A3%E7%82%B9%E4%BA%8B/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/android/">Android</a>,&nbsp;<a href="/tags/gc/">GC</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2016/01/19/android%E6%97%A0%E9%9C%80%E6%9D%83%E9%99%90%E6%98%BE%E7%A4%BA%E6%82%AC%E6%B5%AE%E7%AA%97-%E5%85%BC%E8%B0%88%E9%80%86%E5%90%91%E5%88%86%E6%9E%90app/">Android无需权限显示悬浮窗, 兼谈逆向分析app</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2016-01-19">2016-01-19</time></span></div><div class="content"><!-- raw HTML omitted -->
<p>如下图, 截图是在使用Chrome时截的, 但是屏幕顶部却有UC的view浮在屏幕上. 我使用的是小米, 我并没有给UC授悬浮窗权限, 所以我看到这个悬浮窗时是很震惊的.</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg"
        data-srcset="http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg, http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg 1.5x, http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg 2x"
        data-sizes="auto"
        alt="http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg"
        title="http://ww4.sinaimg.cn/large/62b0904dgw1f04v52p27dj20c80lqabw.jpg" /></p>
<h3 id="悬浮窗原理">悬浮窗原理</h3>
<p>做过悬浮窗功能的人都知道, 要想显示悬浮窗, 要有一个服务运行在后台, 通过<code>getSystemService(Context.WINDOW_SERVICE)</code>拿到WindowManager, 然后向其中addView, addView第二个参数是一个<code>WindowManager.LayoutParams</code>, WindowManager.LayoutParams中有一个成员type, 有各种值, 一般设置成TYPE_PHONE就可以悬浮在很多view的上方了, 但是调用这个方法需要申请<code>android.permission.SYSTEM_ALERT_WINDOW</code>权限, 在很多机型上, 这个权限的名字叫悬浮窗, 比如小米手机上默认是禁用这个权限的, 有些恶意app会用这个权限弹广告, 而且很难追查是哪个应用弹的. 如果这个权限被禁用, 那么结果就是悬浮窗无法展示, 比如有道词典的复制查词功能, 在小米手机上经常没用, 其实是用户没有授权, 而且应用也没有引导用户给它打开授权.</p>
<p>那么他是怎么实现的呢？有人就进行了逆向分析。</p>
<p>过程省略。。。直接说结论</p>
<!-- raw HTML omitted -->
<h3 id="验证">验证</h3>
<p>实际测试了一下, 将type设置成TYPE_TOAST果然有奇效, 不需要<code>android.permission.SYSTEM_ALERT_WINDOW</code>权限就能显示一个悬浮窗.</p>
<p>之前我一直以为调用了系统<code>WindowManager.addView</code>需要<code>android.permission.SYSTEM_ALERT_WINDOW</code>权限, 但实际上调用这个方法是不需要权限的, 在Android源码中有这么一段</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="n">public</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">checkAddPermission</span><span class="p">(</span><span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="w"> </span><span class="n">attrs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">int</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">attrs</span><span class="p">.</span><span class="n">type</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">FIRST_SYSTEM_WINDOW</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">WindowManager</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">.</span><span class="n">LAST_SYSTEM_WINDOW</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">return</span><span class="w"> </span><span class="n">WindowManagerImpl</span><span class="p">.</span><span class="n">ADD_OKAY</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="kd">permission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">switch</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_TOAST</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// XXX right now the app process has complete control over
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// this...  should introduce a token to let the system
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="c1">// monitor/control what they are doing.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_INPUT_METHOD</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_WALLPAPER</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// The window manager will check these.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">            </span><span class="n">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_PHONE</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_PRIORITY_PHONE</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_SYSTEM_ALERT</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_SYSTEM_ERROR</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">TYPE_SYSTEM_OVERLAY</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">permission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="n">Manifest</span><span class="p">.</span><span class="kd">permission</span><span class="p">.</span><span class="n">SYSTEM_ALERT_WINDOW</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">default</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kd">permission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">android</span><span class="p">.</span><span class="n">Manifest</span><span class="p">.</span><span class="kd">permission</span><span class="p">.</span><span class="n">INTERNAL_SYSTEM_WINDOW</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">if</span><span class="w"> </span><span class="p">(</span><span class="kd">permission</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">if</span><span class="w"> </span><span class="p">(</span><span class="n">mContext</span><span class="p">.</span><span class="n">checkCallingOrSelfPermission</span><span class="p">(</span><span class="kd">permission</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="o">!=</span><span class="w"> </span><span class="n">PackageManager</span><span class="p">.</span><span class="n">PERMISSION_GRANTED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">return</span><span class="w"> </span><span class="n">WindowManagerImpl</span><span class="p">.</span><span class="n">ADD_PERMISSION_DENIED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="n">WindowManagerImpl</span><span class="p">.</span><span class="n">ADD_OKAY</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>可以猜到这个方法是往系统的WindowManager里addView的时候做权限检查用的, 那个<code>type</code>就是我们在构造<code>WindowManager.LayoutParams</code>时赋值的<code>type</code>, 可以看到, 除了<code>TYPE_TOAST</code>, 其他都是要权限的, 而且非常喜感的是, 代码中的注释还说他们现在对这种type毫无限制, 应该引入标记来限制开发者.</p></div><div class="post-footer">
        <a href="/post/2016/01/19/android%E6%97%A0%E9%9C%80%E6%9D%83%E9%99%90%E6%98%BE%E7%A4%BA%E6%82%AC%E6%B5%AE%E7%AA%97-%E5%85%BC%E8%B0%88%E9%80%86%E5%90%91%E5%88%86%E6%9E%90app/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/android/">Android</a>,&nbsp;<a href="/tags/%E6%82%AC%E6%B5%AE%E6%A1%86/">悬浮框</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2016/01/19/git-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">Git:代码冲突常见解决方法</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2016-01-19">2016-01-19</time></span></div><div class="content"><p>使用git，当本地文件修改后，使用<code>git pull</code>会报错<code>error: Your local changes to the following files would be overwritten by merge:</code></p>
<p>此时可以使用如下解决方案</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">git stash  
</span></span><span class="line"><span class="cl">git pull  
</span></span><span class="line"><span class="cl">git stash pop  
</span></span></code></pre></div><p>但是有一个问题需要注意，合并后会生成类似<code>====&gt;</code>之类的东西,需要手动去处理下，不然会有问题的。</p></div><div class="post-footer">
        <a href="/post/2016/01/19/git-%E4%BB%A3%E7%A0%81%E5%86%B2%E7%AA%81%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/git%E5%86%B2%E7%AA%81/">Git冲突</a></div></div>
</article><article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
        <a href="/post/2015/11/17/%E4%BD%BF%E7%94%A8-nvm-%E7%AE%A1%E7%90%86%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84-node-%E4%B8%8E-npm/">mac 使用 nvm 管理不同版本的 node 与 npm</a>
    </h1><div class="post-meta"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>SimonChen</a>
</span>&nbsp;<span class="post-publish">published on <time datetime="2015-11-17">2015-11-17</time></span></div><div class="content"><p>我最开始通过brew安装的nvm，发现各种坑，经常导致我的终端启动卡死。一堆的资源没有激活之类的提示。然后突然找到一篇文章，说通过brew安装的nvm路径有问题，建议直接全局安装nvm。然后试了下，果然效果拔萃，把brew安装的nvm卸载后，现在终端启动终于正常了。</p>
<p>nvm 是 Mac 下的 node 管理工具，有点类似管理 Ruby 的 rvm，如果是需要管理 Windows 下的 node，官方推荐是使用 nvmw 或 nvm-windows 。</p>
<h3 id="一卸载已安装到全局的-nodenpm">一、卸载已安装到全局的 node/npm</h3>
<p>如果之前是在官网下载的 node 安装包，运行后会自动安装在全局目录，其中</p>
<p>node 命令在 /usr/local/bin/node ，npm 命令在全局 node_modules 目录中，具体路径为 /usr/local/lib/node_modules/npm</p>
<p>安装 nvm 之后最好先删除下已安装的 node 和全局 node 模块：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">npm ls -g --depth=0 #查看已经安装在全局的模块，以便删除这些全局模块后再按照不同的 node 版本重新进行全局安装
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo rm -rf /usr/local/lib/node_modules #删除全局 node_modules 目录
</span></span><span class="line"><span class="cl">sudo rm /usr/local/bin/node #删除 node
</span></span><span class="line"><span class="cl">cd  /usr/local/bin &amp;&amp; ls -l | grep &#34;../lib/node_modules/&#34; | awk &#39;{print $9}&#39;| xargs rm #删除全局 node 模块注册的软链
</span></span></code></pre></div><h3 id="二安装-nvm">二、安装 nvm</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.29.0/install.sh | bash
</span></span></code></pre></div><p>安装完成后请重新打开终端环境，Mac 下推荐使用 <a href="https://github.com/robbyrussell/oh-my-zsh" target="_blank" rel="noopener noreffer">oh-my-zsh</a>
 代替默认的 bash shell。</p></div><div class="post-footer">
        <a href="/post/2015/11/17/%E4%BD%BF%E7%94%A8-nvm-%E7%AE%A1%E7%90%86%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%AC%E7%9A%84-node-%E4%B8%8E-npm/">Read More</a><div class="post-tags">
                <i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/%E8%BD%AC%E8%BD%BD/">转载</a>,&nbsp;<a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">环境搭建</a></div></div>
</article><ul class="pagination"><li class="page-item ">
                    <span class="page-link">
                        <a href="/">1</a>
                    </span>
                </li><li class="page-item ">
                    <span class="page-link" aria-hidden="true">&hellip;</span>
                </li><li class="page-item ">
                    <span class="page-link">
                        <a href="/page/9/">9</a>
                    </span>
                </li><li class="page-item ">
                    <span class="page-link">
                        <a href="/page/10/">10</a>
                    </span>
                </li><li class="page-item active">
                    <span class="page-link">
                        <a href="/page/11/">11</a>
                    </span>
                </li><li class="page-item ">
                    <span class="page-link">
                        <a href="/page/12/">12</a>
                    </span>
                </li><li class="page-item ">
                    <span class="page-link">
                        <a href="/page/13/">13</a>
                    </span>
                </li><li class="page-item ">
                    <span class="page-link" aria-hidden="true">&hellip;</span>
                </li><li class="page-item ">
                    <span class="page-link">
                        <a href="/page/41/">41</a>
                    </span>
                </li></ul></div></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2011 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">SimonChen</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.1/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/typeit@8.5.4/dist/index.umd.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"data":{"id-1":"仙人抚我顶，结发受长生"},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
