<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Jenkins on 编程心语</title>
    <link>https://www.ithome.me/tags/jenkins/</link>
    <description>Recent content in Jenkins on 编程心语</description>
    <generator>Hugo</generator>
    <language>zh-CN</language>
    <copyright>©{year}, All Rights Reserved. Simon Chen</copyright>
    <lastBuildDate>Tue, 31 Jul 2018 14:18:43 +0800</lastBuildDate>
    <atom:link href="https://www.ithome.me/tags/jenkins/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>jenkins&#43;fastlane&#43;ios自动化打包实战</title>
      <link>https://www.ithome.me/post/2018/07/31/jenkins-fastlane-ios%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%93%E5%8C%85%E5%AE%9E%E6%88%98/</link>
      <pubDate>Tue, 31 Jul 2018 14:18:43 +0800</pubDate>
      <guid>https://www.ithome.me/post/2018/07/31/jenkins-fastlane-ios%E8%87%AA%E5%8A%A8%E5%8C%96%E6%89%93%E5%8C%85%E5%AE%9E%E6%88%98/</guid>
      <description>&lt;p&gt;当项目达到一定规模后，为了便于管理，我们都会引入自动化构建。本篇主要是讲述如果通过jenkins和fastlane实现iOS的打包。&lt;/p&gt;&#xA;&lt;p&gt;关于jenkins的搭建就不多说了，大家可以按照网上的文章去配置，基本都是傻瓜式一键安装。&lt;/p&gt;&#xA;&lt;p&gt;本文将要解决的问题是如何在jenkins搭建iOS的自动编译job。&lt;/p&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;构建iOS的包只能在Mac机器上进行，如果Jenkins搭建在Linux或者非Mac机器上，需要在Jenkins中配置slave节点连接到Mac电脑。&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;h3 id=&#34;1-准备工作&#34;&gt;&lt;strong&gt;1. 准备工作&lt;/strong&gt;&lt;/h3&gt;&#xA;&lt;blockquote&gt;&#xA;&lt;p&gt;Q:为何是通过fastlane来构建iOS，而不是通过Jenkins的Xcode插件来构建呢？&#xA;A:Xcode插件方式不仅配置麻烦，而且配置完成后还需要大量的调试工作才能正确编译。而fastlane只需要配置一次，简单方便。&lt;/p&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;既然是通过fastlane来构建,那么我们首先得需要配置好fastlane相关的东西。&lt;/p&gt;&#xA;&lt;h4 id=&#34;11-安装fastlane&#34;&gt;&lt;strong&gt;1.1 安装fastlane&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;p&gt;&lt;em&gt;在Mac编译机上需要配置好fastlane&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;打包iOS我们需要保证xcode命令行已经正确安装&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;xcode-select --install  //命令行输入，如果未安装会弹出对话框提示安装，否则会提示已经安装&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;可以通过两种方式来安装&lt;a href=&#34;https://fastlane.tools/&#34; target=&#34;_blank&#34; rel=&#34;noopener noreffer&#34;&gt;fastlane&lt;/a&gt;&#xA;&#xA;&lt;strong&gt;方式一：&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[sudo] gem install fastlane -NV&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;strong&gt;方式二：&lt;/strong&gt;&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;brew cask install fastlane&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&#34;12-项目中配置fastlane&#34;&gt;&lt;strong&gt;1.2 项目中配置fastlane&lt;/strong&gt;&lt;/h4&gt;&#xA;&lt;p&gt;&lt;em&gt;给我们需要自动化编译的iOS工程配置fastlane&lt;/em&gt;&lt;/p&gt;&#xA;&lt;p&gt;假如我们现在有一个&lt;code&gt;BlocklySample&lt;/code&gt;的工程，我们需要在项目根目录下执行命令行&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;fastlane init&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;会有如下图这样的提示，需要我们选择哪种任务，这里我们可以选&lt;code&gt;2&lt;/code&gt;或者&lt;code&gt;3&lt;/code&gt;。选择这两个选择后会提示让你输入iOS开发者的账号密码，这样会自动给你生成团队信息、bid和基本编译脚本等等。&#xA;&lt;img&#xA;        class=&#34;lazyload&#34;&#xA;        src=&#34;https://www.ithome.me/svg/loading.min.svg&#34;&#xA;        data-src=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg&#34;&#xA;        data-srcset=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg, http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg 1.5x, http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg 2x&#34;&#xA;        data-sizes=&#34;auto&#34;&#xA;        alt=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg&#34;&#xA;        title=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343039262110.jpg&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;执行完成后在项目根目录下会自动新建一个fastlane的目录&#xA;&lt;img&#xA;        class=&#34;lazyload&#34;&#xA;        src=&#34;https://www.ithome.me/svg/loading.min.svg&#34;&#xA;        data-src=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg&#34;&#xA;        data-srcset=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg, http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg 1.5x, http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg 2x&#34;&#xA;        data-sizes=&#34;auto&#34;&#xA;        alt=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg&#34;&#xA;        title=&#34;http://7xq9ge.com1.z0.glb.clouddn.com/2018-08-15-15343127999279.jpg&#34; /&gt;&lt;/p&gt;&#xA;&lt;p&gt;修改fastlane目录下的Fastfile文件&lt;/p&gt;&#xA;&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;# This file contains the fastlane.tools configuration&#xA;# You can find the documentation at https://docs.fastlane.tools&#xA;#&#xA;# For a list of all available actions, check out&#xA;#&#xA;#     https://docs.fastlane.tools/actions&#xA;#&#xA;# For a list of all available plugins, check out&#xA;#&#xA;#     https://docs.fastlane.tools/plugins/available-plugins&#xA;#&#xA;&#xA;# Uncomment the line if you want fastlane to automatically update itself&#xA;# update_fastlane&#xA;&#xA;default_platform(:ios)&#xA;&#xA;platform :ios do&#xA;  desc &amp;#34;Push a new release build to the App Store&amp;#34;&#xA;  lane :release_appstore do&#xA;    increment_build_number(xcodeproj: &amp;#34;xxx.xcodeproj&amp;#34;)&#xA;    update_project_provisioning(&#xA;        # 之前有sigh下载的描述文件存储路径&#xA;        profile:&amp;#34;fastlane/provision/xxx.mobileprovision&amp;#34;,&#xA;        # 打包配置，Debug，Release&#xA;        build_configuration:&amp;#34;Release&amp;#34;&#xA;    )&#xA;    automatic_code_signing(&#xA;        # 工程文件所在路径&#xA;        path:&amp;#34;xxx.xcodeproj&amp;#34;,&#xA;        # 是否使用自动签名，这里如果是打包的话应该一般都为false吧，默认也是false&#xA;        use_automatic_signing:false,&#xA;        # 这个就不用说了，需要修改的targets&#xA;        targets:&amp;#34;xxx&amp;#34;,&#xA;        # 用哪种方式打包“iPhone Develop”还是“iPhone Distribution”&#xA;        code_sign_identity:&amp;#34;iPhone Distribution&amp;#34;,&#xA;        # 描述文件名称， 也就是使用哪个描述文件打包&#xA;        profile_name:&amp;#34;xxx&amp;#34;&#xA;    )&#xA;    scheme_name = &amp;#39;xxx&amp;#39;&#xA;    configuration = &amp;#39;AppStore&amp;#39;&#xA;    version = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleShortVersionString&amp;#34;)&#xA;    build = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleVersion&amp;#34;)&#xA;    output_directory = File.expand_path(&amp;#34;..&amp;#34;, Dir.pwd) + File::Separator + &amp;#39;build&amp;#39;&#xA;    output_name = &amp;#34;#{scheme_name}_#{configuration}_#{version}_#{build}_#{Time.now.strftime(&amp;#39;%Y%m%d%H%M%S&amp;#39;)}.ipa&amp;#34;&#xA;    build_app(workspace: &amp;#34;xxx.xcworkspace&amp;#34;, scheme: &amp;#34;xxx&amp;#34;, export_method: &amp;#34;app-store&amp;#34;, output_directory: output_directory,&#xA;      output_name: output_name)&#xA;    upload_to_app_store&#xA;  end&#xA;  desc &amp;#34;Push a new release build to the Testflight&amp;#34;&#xA;  lane :release_testflight do&#xA;    update_project_provisioning(&#xA;        # 之前有sigh下载的描述文件存储路径&#xA;        profile:&amp;#34;fastlane/provision/xxx.mobileprovision&amp;#34;,&#xA;        # 打包配置，Debug，Release&#xA;        build_configuration:&amp;#34;Release&amp;#34;&#xA;    )&#xA;    automatic_code_signing(&#xA;        # 工程文件所在路径&#xA;        path:&amp;#34;xxx.xcodeproj&amp;#34;,&#xA;        # 是否使用自动签名，这里如果是打包的话应该一般都为false吧，默认也是false&#xA;        use_automatic_signing:false,&#xA;        # 这个就不用说了，需要修改的targets&#xA;        targets:&amp;#34;xxx&amp;#34;,&#xA;        # 用哪种方式打包“iPhone Develop”还是“iPhone Distribution”&#xA;        code_sign_identity:&amp;#34;iPhone Distribution&amp;#34;,&#xA;        # 描述文件名称， 也就是使用哪个描述文件打包&#xA;        profile_name:&amp;#34;xxx&amp;#34;&#xA;    )&#xA;    scheme_name = &amp;#39;xxx&amp;#39;&#xA;    configuration = &amp;#39;AppStore&amp;#39;&#xA;    version = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleShortVersionString&amp;#34;)&#xA;    build = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleVersion&amp;#34;)&#xA;    output_directory = File.expand_path(&amp;#34;..&amp;#34;, Dir.pwd) + File::Separator + &amp;#39;build&amp;#39;&#xA;    output_name = &amp;#34;#{scheme_name}_#{configuration}_#{version}_#{build}_#{Time.now.strftime(&amp;#39;%Y%m%d%H%M%S&amp;#39;)}.ipa&amp;#34;&#xA;    build_app(workspace: &amp;#34;xxx.xcworkspace&amp;#34;, scheme: &amp;#34;xxx&amp;#34;, export_method: &amp;#34;app-store&amp;#34;, output_directory: output_directory,&#xA;      output_name: output_name)&#xA;    upload_to_testflight&#xA;  end&#xA;  desc &amp;#34;Push a new release build to the Ad Hoc&amp;#34;&#xA;  lane :release_adhoc do |option|&#xA;  &#x9;# cocoapods&#xA;  &#x9;#根据传入参数version设置app的版本号&#xA;&#x9;# increment_version_number(version_number: option[:version]) &#xA;&#x9;#自动增加build号&#xA;&#x9;#increment_build_number&#xA;  &#x9;update_project_provisioning(&#xA;        # 之前有sigh下载的描述文件存储路径&#xA;        profile:&amp;#34;fastlane/provision/xxx.mobileprovision&amp;#34;,&#xA;        # 打包配置，Debug，Release&#xA;        build_configuration:&amp;#34;Release&amp;#34;&#xA;    )&#xA;  &#x9;automatic_code_signing(&#xA;        # 工程文件所在路径&#xA;        path:&amp;#34;xxx.xcodeproj&amp;#34;,&#xA;        # 是否使用自动签名，这里如果是打包的话应该一般都为false吧，默认也是false&#xA;        use_automatic_signing:false,&#xA;        # 打包的team ID， 也就是打包使用的证书中的team ID，这个如果不知道是什么的话可以在xCode中设置好签名用的描述文件后到xcodeproj下的pbxproj文件中搜索“DEVELOPMENT_TEAM”，它的值就是了&#xA;        team_id:&amp;#34;RRRRR5555&amp;#34;,&#xA;        # 这个就不用说了，需要修改的targets&#xA;        targets:&amp;#34;xxx&amp;#34;,&#xA;        # 用哪种方式打包“iPhone Develop”还是“iPhone Distribution”&#xA;        code_sign_identity:&amp;#34;iPhone Distribution&amp;#34;,&#xA;        # 描述文件名称， 也就是使用哪个描述文件打包&#xA;        profile_name:&amp;#34;xxx&amp;#34;&#xA;    )&#xA;    #证书签名&#xA;    # sigh&#xA;    #编译打包&#xA;    scheme_name = &amp;#39;xxx&amp;#39;&#xA;    configuration = &amp;#39;Release&amp;#39;&#xA;    version = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleShortVersionString&amp;#34;)&#xA;    build = get_info_plist_value(path: &amp;#34;./#{scheme_name}/Info.plist&amp;#34;, key: &amp;#34;CFBundleVersion&amp;#34;)&#xA;    output_directory = File.expand_path(&amp;#34;..&amp;#34;, Dir.pwd) + File::Separator + &amp;#39;build&amp;#39;&#xA;    output_name = &amp;#34;#{scheme_name}_#{configuration}_#{version}_#{build}_#{Time.now.strftime(&amp;#39;%Y%m%d%H%M%S&amp;#39;)}.ipa&amp;#34;&#xA;    gym(&#xA;    &#x9;scheme: scheme_name, &#xA;    &#x9;clean: true, &#xA;    &#x9;silent:true,&#xA;    &#x9;export_method:&amp;#39;ad-hoc&amp;#39;, &#xA;    &#x9;export_options: {&#xA;      &#x9;  provisioningProfiles: { &#xA;      &#x9;  #前面的是bundle id，后面的是对应用到的mobileprovision，只需要名字，不需要后缀&#xA;          &amp;#34;me.ithome.xxx&amp;#34; =&amp;gt; &amp;#34;xxx&amp;#34;&#xA;        }},&#xA;        configuration: configuration, &#xA;        output_directory: output_directory, &#xA;        output_name: output_name, &#xA;        # 签名证书的名称，去钥匙串-登录-证书里面复制&#xA;        codesigning_identity:&amp;#39;iPhone Distribution: xxx (Rxxx47)&amp;#39;,&#xA;        export_xcargs: &amp;#39;-allowProvisioningUpdates&amp;#39;)&#xA;        # 上传到蒲公英，需要安装pgyer插件&#xA;        #pgyer(api_key: &amp;#34;aaaa&amp;#34;, user_key: &amp;#34;bbbb&amp;#34;)&#xA;  end&#xA;end&#xA;&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;&#xA;&lt;ul&gt;&#xA;&lt;li&gt;上述脚本中有部分xxx之类的东西，需要自行替换成自己项目的。&lt;/li&gt;&#xA;&lt;li&gt;所有脚本中用到的xxx.mobileprovision都需要双击安装一次，否者会提示找不到。&lt;/li&gt;&#xA;&lt;li&gt;需要安装好p12证书文件。&lt;/li&gt;&#xA;&lt;/ul&gt;&#xA;&lt;/blockquote&gt;&#xA;&lt;p&gt;修改完成后我们就有了三个命令，用来分别打包上传到appstore、testflight和蒲公英。&#xA;&lt;code&gt;fastlane release_appstore&lt;/code&gt;&#xA;&lt;code&gt;fastlane release_testflight&lt;/code&gt;&#xA;&lt;code&gt;fastlane release_adhoc&lt;/code&gt;&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
